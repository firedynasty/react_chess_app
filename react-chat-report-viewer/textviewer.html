<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Image Gallery with Thumbnail Carousel</title>
    <!-- Markdown and syntax highlighting libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/default.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Open Sans", Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        #gallery {
            position: relative;
            background: url('https://cdn.pixabay.com/photo/2013/11/03/08/05/cheers-204742_1280.jpg');
            height: 100vh;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s linear;
            padding: 0;
            padding-top: 80px;
            margin-left: 250px;
        }

        #gallery::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 0;
        }

        .gallery-section-headline,
        .gallery-preview-container,
        .gallery-btn,
        .thumbnails-section {
            position: relative;
            z-index: 1;
        }

        .gallery-section-headline {
            display: none;
        }

        .gallery-preview-container {
            position: relative;
            max-width: 100%;
            height: calc(100vh - 80px);
            text-align: center;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .gallery-preview-title {
            display: none;
        }

        .content-title {
            font-size: 24px;
            font-weight: bold;
            color: #007acc;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007acc;
        }

        .gallery-preview-image,
        .gallery-preview-video {
            max-width: 90%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.3s linear;
        }

        .gallery-preview-video {
            display: none;
        }

        .gallery-preview-image {
            display: block;
        }

        .gallery-preview-text {
            display: none;
            max-width: 95%;
            max-height: 100%;
            background: white;
            color: #333;
            padding: 40px;
            border-radius: 10px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: left;
        }

        .gallery-preview-markdown {
            display: none;
            max-width: 95%;
            max-height: 100%;
            background: white;
            color: #333;
            padding: 40px;
            border-radius: 10px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            text-align: left;
        }

        .gallery-preview-markdown h1 {
            font-size: 2em;
            font-weight: bold;
            margin-top: 24px;
            margin-bottom: 16px;
            color: #1a1a1a;
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 0.3em;
        }

        .gallery-preview-markdown h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 24px;
            margin-bottom: 16px;
            color: #1a1a1a;
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 0.3em;
        }

        .gallery-preview-markdown h3 {
            font-size: 1.25em;
            font-weight: bold;
            margin-top: 24px;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .gallery-preview-markdown h4, .gallery-preview-markdown h5, .gallery-preview-markdown h6 {
            font-weight: bold;
            margin-top: 24px;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .gallery-preview-markdown p {
            margin-bottom: 16px;
        }

        .gallery-preview-markdown strong {
            font-weight: bold;
        }

        .gallery-preview-markdown em {
            font-style: italic;
        }

        .gallery-preview-markdown code {
            background-color: rgba(27, 31, 35, 0.05);
            border-radius: 3px;
            font-family: 'Courier New', Consolas, Monaco, monospace;
            font-size: 85%;
            margin: 0;
            padding: 0.2em 0.4em;
        }

        .gallery-preview-markdown pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
            margin-bottom: 16px;
        }

        .gallery-preview-markdown pre code {
            background-color: transparent;
            padding: 0;
            font-size: 100%;
            line-height: 1.45;
            display: block;
        }

        .gallery-preview-markdown ul, .gallery-preview-markdown ol {
            margin-bottom: 16px;
            padding-left: 2em;
        }

        .gallery-preview-markdown li {
            margin-bottom: 0.25em;
        }

        .gallery-preview-markdown blockquote {
            border-left: 4px solid #dfe2e5;
            color: #6a737d;
            padding-left: 1em;
            margin-bottom: 16px;
        }

        .gallery-preview-markdown a {
            color: #0366d6;
            text-decoration: none;
        }

        .gallery-preview-markdown a:hover {
            text-decoration: underline;
        }

        .gallery-preview-markdown hr {
            border: none;
            border-top: 1px solid #e1e4e8;
            margin: 24px 0;
        }

        .gallery-preview-markdown table {
            border-collapse: collapse;
            margin-bottom: 16px;
            width: 100%;
        }

        .gallery-preview-markdown table th,
        .gallery-preview-markdown table td {
            border: 1px solid #dfe2e5;
            padding: 6px 13px;
        }

        .gallery-preview-markdown table th {
            background-color: #f6f8fa;
            font-weight: bold;
        }

        .gallery-preview-markdown table tr:nth-child(2n) {
            background-color: #f6f8fa;
        }

        .gallery-preview-divider {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 40px;
        }

        .divider-title {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .divider-subtitle {
            font-size: 1.5em;
            opacity: 0.9;
        }

        .gallery-btn {
            width: 64px;
            height: 64px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            border: none;
            padding: 0;
            cursor: pointer;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            transition: all 0.3s ease;
        }

        .gallery-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }

        .gallery-btn:active {
            transform: translateY(-50%) scale(0.9);
        }

        .prev-btn {
            left: 10px;
        }

        .next-btn {
            right: 10px;
        }

        /* Sidebar Section (Left) */
        .thumbnails-section {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background-color: #f5f5f5;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            z-index: 50;
        }

        .thumbnails-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        .thumbnails-slider {
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .thumbnail {
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .thumbnail:hover {
            background-color: #e0e0e0;
        }

        .thumbnail.active {
            background-color: #d0d0d0;
        }

        .thumbnail-image-wrapper {
            display: none;
        }

        .thumbnail-caption {
            font-size: 13px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .thumbnail-divider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: bold;
            font-size: 12px;
            color: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }

        .thumbnail-divider .thumbnail-caption {
            color: white;
        }

        /* Hide thumbnail nav buttons */
        .thumbnail-nav-btn {
            display: none;
        }

        /* Control Bar Container */
        .control-bar {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
        }

        /* URL Instructions */
        .url-instructions {
            display: none;
        }

        /* Reference Button */
        .reference-btn {
            background: rgba(255, 165, 0, 0.9);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .reference-btn:hover {
            background: rgba(255, 140, 0, 1);
            transform: scale(1.05);
        }

        /* Drop Folder Button */
        #dragDropFolderBtn {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        #dragDropFolderBtn:hover {
            background: rgba(67, 160, 71, 1);
            transform: scale(1.05);
        }

        #dragDropFolderBtn.drag-over {
            background: rgba(33, 150, 243, 0.9);
            border-color: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }

        /* Drag-Drop Button */
        .drag-drop-btn {
            position: absolute;
            top: 120px;
            left: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: none; /* Hidden by default */
        }

        .drag-drop-btn:hover {
            background: rgba(67, 160, 71, 1);
            transform: scale(1.05);
        }

        .drag-drop-btn.drag-over {
            background: rgba(33, 150, 243, 0.9);
            border-color: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }

        /* Hidden file input */
        #file_input {
            display: none;
        }

        /* Navigation Input */
        .nav-input-container {
            position: absolute;
            top: 170px;
            left: 20px;
            display: none; /* Hidden */
            gap: 8px;
            align-items: center;
            z-index: 100;
        }

        /* Folder Path Input */
        .folder-path-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .folder-path-input {
            width: 250px;
            padding: 10px 12px;
            font-size: 13px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-weight: normal;
            font-family: monospace;
            transition: all 0.3s ease;
        }

        .folder-path-input:focus {
            outline: none;
            border-color: rgba(255, 165, 0, 0.9);
            background: rgba(0, 0, 0, 0.7);
        }

        .folder-path-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .load-folder-btn {
            padding: 10px 16px;
            background: rgba(255, 165, 0, 0.9);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }

        .load-folder-btn:hover {
            background: rgba(255, 140, 0, 1);
            transform: scale(1.05);
        }

        .load-folder-btn:active {
            transform: scale(0.95);
        }

        /* Font Size Controls */
        .font-size-controls {
            display: flex;
            gap: 8px;
        }

        .font-size-btn {
            width: 40px;
            height: 40px;
            background: rgba(33, 150, 243, 0.9);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .font-size-btn:hover {
            background: rgba(25, 118, 210, 1);
            transform: scale(1.05);
        }

        .font-size-btn:active {
            transform: scale(0.95);
        }

        .nav-input {
            width: 80px;
            padding: 10px 12px;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-input:focus {
            outline: none;
            border-color: rgba(255, 165, 0, 0.9);
            background: rgba(0, 0, 0, 0.7);
        }

        .nav-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .nav-input.typing {
            border-color: rgba(0, 255, 0, 0.7);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .nav-go-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 165, 0, 0.9);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .nav-go-btn:hover {
            background: rgba(255, 140, 0, 1);
            transform: scale(1.1);
        }

        .nav-go-btn:active {
            transform: scale(0.95);
        }

        .nav-go-btn svg {
            color: white;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #007acc;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: #007acc;
            font-size: 24px;
        }

        .modal-instructions {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007acc;
            font-size: 14px;
            color: #333;
        }

        .modal-instructions code {
            background: #e3f2fd;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #d63384;
            font-weight: bold;
        }

        .close-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #cc0000;
            transform: rotate(90deg);
        }

        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .reference-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .reference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007acc;
            transition: all 0.3s ease;
        }

        .reference-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .reference-number {
            font-size: 18px;
            font-weight: bold;
            color: #007acc;
            min-width: 50px;
        }

        .reference-key {
            font-family: monospace;
            font-size: 14px;
            color: #333;
            flex-grow: 1;
            margin: 0 15px;
        }

        .reference-go-btn {
            background: #007acc;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .reference-go-btn:hover {
            background: #005a99;
        }

        .reference-go-btn:active {
            transform: scale(0.95);
        }

        .reference-go-btn.clicked {
            background: #28a745;
        }

        /* Scrollbar for modal */
        .modal-body::-webkit-scrollbar {
            width: 10px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #007acc;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #005a99;
        }

        /* Responsive Design */
        @media screen and (max-width: 768px) {
            .gallery-section-headline {
                font-size: 28px;
                height: 10vh;
            }

            .gallery-preview-container {
                height: 50vh;
            }

            .thumbnails-section {
                height: 25vh;
            }

            .thumbnail {
                width: 90px;
                height: 60px;
            }

            .thumbnails-slider {
                padding: 10px 50px;
            }

            .url-instructions {
                position: relative;
                top: auto;
                right: auto;
                max-width: 100%;
                margin: 10px;
            }
        }

        @media screen and (max-width: 480px) {
            .gallery-section-headline {
                font-size: 20px;
            }

            .gallery-btn {
                width: 48px;
                height: 48px;
            }

            .gallery-btn svg {
                width: 48px;
                height: 48px;
            }

            .thumbnail {
                width: 70px;
                height: 50px;
            }
        }
    </style>
</head>

<body>
    <section id="gallery">
        <!-- Control Bar - All controls in one row -->
        <div class="control-bar">
            <button class="reference-btn" onclick="openModal()">üìã View Reference</button>

            <!-- Load Reference Image Button -->
            <button id="loadRefImageBtn" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">üñºÔ∏è Load Reference Image</button>
            <input type="file" id="refImageFileInput" accept="image/*" style="display: none;">

            <!-- Drag-drop button for folders -->
            <button id="dragDropFolderBtn" onclick="document.getElementById('folder_input').click()">
                üìÇ Drop Folder Here
            </button>

            <!-- Folder Path Input -->
            <div class="folder-path-container">
                <input type="text" class="folder-path-input" id="folderPathInput" placeholder="./ or imageGallery/images" title="Enter ./ for current directory or a relative path to folder">
                <button class="load-folder-btn" id="loadFolderBtn" onclick="loadFolderPath()">üìÇ Load Folder</button>
            </div>

            <!-- Font Size Controls -->
            <div class="font-size-controls">
                <button class="font-size-btn" id="fontSizeDecrease" onclick="changeFontSize(-2)" title="Decrease font size">-</button>
                <button class="font-size-btn" id="fontSizeIncrease" onclick="changeFontSize(2)" title="Increase font size">+</button>
            </div>

            <div class="url-instructions">
                <div>Navigate directly: <code>?5</code> - Fifth image</div>
            </div>
        </div>

        <!-- Hidden file input for individual files -->
        <input type="file" id="file_input" accept="image/*,video/*,text/plain,.txt,.md" multiple style="display: none;">

        <!-- Hidden file input for folders -->
        <input type="file" id="folder_input" accept="image/*,video/*,text/plain,.txt,.md" webkitdirectory style="display: none;">

        <!-- Drag-drop button for files (hidden) -->
        <button class="drag-drop-btn" id="dragDropBtn" onclick="document.getElementById('file_input').click()">
            üìÅ Drop Files Here
        </button>

        <!-- Navigation Input (Hidden) -->
        <div class="nav-input-container">
            <input type="number" class="nav-input" id="navInput" placeholder="Go to #" min="1">
            <button class="nav-go-btn" id="navGoBtn" onclick="navigateToInput()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                    <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
            </button>
        </div>

        <div class="gallery-section-headline">Gallery</div>

        <div class="gallery-preview-container">
            <div class="gallery-preview-title"></div>
            <img class="gallery-preview-image" src="" alt="Gallery Image">
            <video class="gallery-preview-video" controls loop autoplay muted preload="metadata">
                <source src="" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <div class="gallery-preview-text">Loading text...</div>
            <div class="gallery-preview-markdown">Loading markdown...</div>
            <div class="gallery-preview-divider">
                <div class="divider-title"></div>
                <div class="divider-subtitle"></div>
            </div>

            <button class="gallery-btn prev-btn" aria-label="Previous Image">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
                    <path d="M44 8 L20 32 L44 56" stroke="white" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

            <button class="gallery-btn next-btn" aria-label="Next Image">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
                    <path d="M20 8 L44 32 L20 56" stroke="white" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>

        <div class="thumbnails-section">
            <div class="thumbnails-container">
                <div class="thumbnails-slider">
                    <!-- Thumbnails will be generated here by JavaScript -->
                </div>

                <button class="thumbnail-nav-btn thumbnail-prev-btn" aria-label="Scroll Thumbnails Left">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1280 1792">
                        <path fill="#fff" d="M1171 301L640 832l531 531q19 19 19 45t-19 45l-166 166q-19 19-45 19t-45-19L173 877q-19-19-19-45t19-45L915 45q19-19 45-19t45 19l166 166q19 19 19 45t-19 45z" />
                    </svg>
                </button>

                <button class="thumbnail-nav-btn thumbnail-next-btn" aria-label="Scroll Thumbnails Right">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1280 1792">
                        <path fill="#fff" d="M1107 877l-742 742q-19 19-45 19t-45-19l-166-166q-19-19-19-45t19-45l531-531-531-531q-19-19-19-45t19-45L275 45q19-19 45-19t45 19l742 742q19 19 19 45t-19 45z" />
                    </svg>
                </button>
            </div>
        </div>
    </section>

    <!-- Reference Modal -->
    <div id="referenceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Image Reference Guide</h2>
                    <div class="modal-instructions">
                        <strong>üí° Quick Navigation:</strong> Navigate directly using URL parameters like <code>?5</code> to jump to the fifth image
                    </div>
                </div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <ul class="reference-list" id="referenceList">
                    <!-- Generated by JavaScript -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Reference Image Modal -->
    <div id="refImageModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);">
        <div style="background-color: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 800px; max-height: 90vh; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); overflow: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #17a2b8; padding-bottom: 15px;">
                <h2 id="refImageModalTitle" style="margin: 0; color: #17a2b8; font-size: 24px;">üñºÔ∏è Reference Image</h2>
                <div>
                    <button id="loadNewRefImage" style="background: #17a2b8; color: white; border: none; border-radius: 5px; padding: 8px 15px; font-size: 14px; cursor: pointer; margin-right: 10px;">üìÅ Load New Image</button>
                    <button id="toggleRefImageSize" style="background: #6c757d; color: white; border: none; border-radius: 5px; padding: 8px 15px; font-size: 14px; cursor: pointer; margin-right: 10px;">Toggle Size</button>
                    <button id="closeRefImageModal" style="background: #ff4444; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 20px; cursor: pointer;">&times;</button>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <textarea id="refImageNotes" placeholder="Take notes on the image here..." style="display: none; width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
            </div>
            <div id="refImagePreviewContainer" style="text-align: center;">
                <img id="refImagePreview" src="" alt="Reference image" style="max-width: 100%; max-height: 500px; border: 2px solid #ccc; border-radius: 5px; cursor: pointer; display: none;">
                <p id="refImagePlaceholder" style="color: #666; font-style: italic;">No image loaded. Click the button to load an image.</p>
            </div>
        </div>
    </div>

    <script>
        // Gallery Images Dictionary - Replace with your own images and videos
        // Mix of images and videos - videos will be lazy loaded
        const gallery_images_dict = {
            'image1': "https://placehold.co/1080x606/777777/FFF?text=Picture1",
            'video1': "https://www.dropbox.com/scl/fi/rdnbn2id47786c9enla2o/Shylock.mp4?rlkey=4pluvspopyzuryi75dmsic088&st=jmxk2rqr&raw=1",
            'image2': "https://placehold.co/1080x606/888888/FFF?text=Picture2",
            'image3': "https://placehold.co/1080x606/999999/FFF?text=Picture3",
            'video2': "https://www.dropbox.com/scl/fi/i9096parwwsmkkhedbwc3/Lover-s-Complaint.mp4?rlkey=0nh036q9llk9t1az9v3z71pp8&st=o2mlkawd&raw=1",
            'image4': "https://placehold.co/1080x606/666666/FFF?text=Picture4",
            'image5': "https://placehold.co/1080x606/555555/FFF?text=Picture5",
            'image6': "https://placehold.co/1080x606/444444/FFF?text=Picture6",
            'image7': "https://placehold.co/1080x606/333333/FFF?text=Picture7"
        };

        // Convert dictionary to array of objects for easier iteration
        // Can include dividers for sets
        const gallery_images = Object.entries(gallery_images_dict).map(([key, url]) => {
            if (url === 'DIVIDER') {
                return {
                    key: key,
                    url: url,
                    type: 'divider',
                    isVideo: false,
                    isText: false,
                    isMarkdown: false
                };
            }
            return {
                key: key,
                url: url,
                type: isMarkdownUrl(url) ? 'markdown' : (isTextUrl(url) ? 'text' : (isVideoUrl(url) ? 'video' : 'image')),
                isVideo: isVideoUrl(url),
                isText: isTextUrl(url),
                isMarkdown: isMarkdownUrl(url)
            };
        });

        // DOM Elements
        let currentIndex = 0;
        // Map to store blob URLs for all images (including subdirectory images for markdown)
        const imagePathToBlobUrl = {};
        const previewImg = document.querySelector('.gallery-preview-image');
        const previewVideo = document.querySelector('.gallery-preview-video');
        const previewText = document.querySelector('.gallery-preview-text');
        const previewMarkdown = document.querySelector('.gallery-preview-markdown');
        const previewDivider = document.querySelector('.gallery-preview-divider');
        const previewTitle = document.querySelector('.gallery-preview-title');
        const thumbnailsSlider = document.querySelector('.thumbnails-slider');
        const prevBtn = document.querySelector('.prev-btn');
        const nextBtn = document.querySelector('.next-btn');
        const thumbnailPrevBtn = document.querySelector('.thumbnail-prev-btn');
        const thumbnailNextBtn = document.querySelector('.thumbnail-next-btn');

        // Helper function to detect if URL is a video
        function isVideoUrl(url) {
            const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.mkv', '.m4v'];
            const urlLower = url.toLowerCase();
            return videoExtensions.some(ext => urlLower.includes(ext));
        }

        // Helper function to detect if URL is a text file
        function isTextUrl(url) {
            const urlLower = url.toLowerCase();
            return urlLower.includes('.txt');
        }

        // Helper function to detect if URL is a markdown file
        function isMarkdownUrl(url) {
            const urlLower = url.toLowerCase();
            return urlLower.includes('.md');
        }

        // Check URL parameters on page load
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const keys = Array.from(urlParams.keys());

            if (keys.length === 0) return;

            const param = keys[0]; // Get first parameter

            // Treat all URL parameters as folder paths and auto-load them
            // This includes: ./, ., imageGallery, imageGallery/images, don_quixote, etc.
            const folderPathInputElement = document.getElementById('folderPathInput');
            if (folderPathInputElement) {
                folderPathInputElement.value = param;
            }
            console.log(`URL parameter "${param}" detected as folder path. Auto-loading...`);
            setTimeout(() => {
                loadFolderPath();
            }, 100);
        }

        // Generate Thumbnails
        function generateThumbnails() {
            gallery_images.forEach((imgData, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'thumbnail';
                thumbnail.setAttribute('data-key', imgData.key);
                if (index === currentIndex) thumbnail.classList.add('active');

                // Create wrapper for the image/video content
                const wrapper = document.createElement('div');
                wrapper.className = 'thumbnail-image-wrapper';

                if (imgData.type === 'divider') {
                    // For divider thumbnails
                    thumbnail.classList.add('thumbnail-divider');
                    const placeholder = document.createElement('div');
                    placeholder.style.width = '100%';
                    placeholder.style.height = '100%';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                    placeholder.style.color = 'white';
                    placeholder.style.fontSize = '11px';
                    placeholder.style.fontWeight = 'bold';
                    placeholder.style.textAlign = 'center';
                    placeholder.style.padding = '5px';
                    placeholder.textContent = imgData.key;
                    wrapper.appendChild(placeholder);
                } else if (imgData.isMarkdown) {
                    // For markdown file thumbnails, create a placeholder with MD label
                    const placeholder = document.createElement('div');
                    placeholder.style.width = '100%';
                    placeholder.style.height = '100%';
                    placeholder.style.background = 'rgba(100,150,255,0.9)';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                    placeholder.style.color = 'white';
                    placeholder.style.fontSize = '14px';
                    placeholder.style.fontWeight = 'bold';
                    placeholder.textContent = 'MD';
                    wrapper.appendChild(placeholder);
                } else if (imgData.isText) {
                    // For text file thumbnails, create a placeholder with TXT label
                    const placeholder = document.createElement('div');
                    placeholder.style.width = '100%';
                    placeholder.style.height = '100%';
                    placeholder.style.background = 'rgba(255,255,255,0.9)';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                    placeholder.style.color = '#333';
                    placeholder.style.fontSize = '14px';
                    placeholder.style.fontWeight = 'bold';
                    placeholder.textContent = 'TXT';
                    wrapper.appendChild(placeholder);
                } else if (imgData.isVideo) {
                    // For video thumbnails, create a placeholder with video icon
                    const placeholder = document.createElement('div');
                    placeholder.style.width = '100%';
                    placeholder.style.height = '100%';
                    placeholder.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                    placeholder.style.color = 'white';
                    placeholder.style.fontSize = '24px';
                    placeholder.innerHTML = '‚ñ∂Ô∏è';
                    wrapper.appendChild(placeholder);
                } else {
                    // Create img element for thumbnail
                    const img = document.createElement('img');
                    img.src = imgData.url;
                    img.alt = imgData.key;
                    wrapper.appendChild(img);
                }

                thumbnail.appendChild(wrapper);

                // Add caption with number and key name
                const caption = document.createElement('div');
                caption.className = 'thumbnail-caption';
                caption.textContent = imgData.key;
                thumbnail.appendChild(caption);

                thumbnailsSlider.appendChild(thumbnail);

                thumbnail.addEventListener('click', () => {
                    changeImage(index);
                });
            });
        }

        // Change Main Image
        function changeImage(index) {
            currentIndex = index;
            const currentItem = gallery_images[currentIndex];
            const currentMedia = currentItem.url;
            const isDivider = currentItem.type === 'divider';
            const isVideo = currentItem.isVideo;
            const isText = currentItem.isText;
            const isMarkdown = currentItem.isMarkdown || currentItem.type === 'markdown';

            console.log('changeImage:', { index, type: currentItem.type, isMarkdown, url: currentMedia });

            // Always pause video first to prevent play/pause conflicts
            previewVideo.pause();

            if (isDivider) {
                // Hide all, show divider
                previewImg.style.display = 'none';
                previewVideo.style.display = 'none';
                previewText.style.display = 'none';
                previewMarkdown.style.display = 'none';
                previewDivider.style.display = 'flex';

                // Update divider content
                const dividerTitle = previewDivider.querySelector('.divider-title');
                const dividerSubtitle = previewDivider.querySelector('.divider-subtitle');
                dividerTitle.textContent = currentItem.key;

                // Count items in this set
                let itemCount = 0;
                for (let i = index + 1; i < gallery_images.length && gallery_images[i].type !== 'divider'; i++) {
                    itemCount++;
                }
                dividerSubtitle.textContent = `${itemCount} item${itemCount !== 1 ? 's' : ''}`;
            } else if (isMarkdown) {
                // Hide all except markdown
                previewImg.style.display = 'none';
                previewVideo.style.display = 'none';
                previewText.style.display = 'none';
                previewDivider.style.display = 'none';
                previewMarkdown.style.display = 'block';
                previewMarkdown.style.opacity = '0';
                previewMarkdown.textContent = 'Loading markdown...';

                // Fetch and display markdown file content
                // Get the base directory of the markdown file for relative image paths
                const mdBasePath = currentMedia.substring(0, currentMedia.lastIndexOf('/') + 1);

                console.log('Fetching markdown from:', currentMedia);

                fetch(currentMedia)
                    .then(response => response.text())
                    .then(text => {
                        // Preprocess markdown to fix image paths with spaces
                        // marked.js has issues parsing image syntax with spaces in filenames
                        const processedText = text.replace(/!\[(.*?)\]\(([^)]+)\)/g, (match, alt, path) => {
                            // URL-encode spaces and other special chars in the path
                            const encodedPath = path.replace(/ /g, '%20');
                            return `![${alt}](${encodedPath})`;
                        });

                        // Parse markdown to HTML
                        const htmlContent = marked.parse(processedText);

                        // Add title before content
                        const titleHtml = `<div class="content-title">${currentItem.key}</div>`;
                        previewMarkdown.innerHTML = titleHtml + htmlContent;

                        console.log('Number of img tags found:', previewMarkdown.querySelectorAll('img').length);

                        // Fix relative image paths
                        previewMarkdown.querySelectorAll('img').forEach((img) => {
                            const src = img.getAttribute('src');
                            // Decode URL-encoded path for lookup
                            const decodedSrc = decodeURIComponent(src);

                            // Only fix relative paths (not absolute URLs or data URIs)
                            if (src && !src.startsWith('http') && !src.startsWith('data:') && !src.startsWith('/') && !src.startsWith('blob:')) {
                                // Handle ./path or just path
                                const cleanSrc = decodedSrc.startsWith('./') ? decodedSrc.substring(2) : decodedSrc;

                                // Check if we have a blob URL for this image (from folder upload)
                                if (imagePathToBlobUrl[cleanSrc]) {
                                    img.src = imagePathToBlobUrl[cleanSrc];
                                    console.log(`‚úì Resolved image from blob map: ${cleanSrc}`);
                                } else if (imagePathToBlobUrl[decodedSrc]) {
                                    img.src = imagePathToBlobUrl[decodedSrc];
                                    console.log(`‚úì Resolved image from blob map (decoded): ${decodedSrc}`);
                                } else {
                                    // Fall back to relative path from markdown file location
                                    img.src = mdBasePath + cleanSrc;
                                    console.log(`‚ö† Using relative path for image: ${mdBasePath + cleanSrc}`);
                                }
                            }
                        });

                        // Apply syntax highlighting to code blocks
                        previewMarkdown.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });

                        previewMarkdown.style.opacity = '1';
                    })
                    .catch(error => {
                        previewMarkdown.textContent = 'Error loading markdown file: ' + error.message;
                        previewMarkdown.style.opacity = '1';
                    });
            } else if (isText) {
                // Hide all except text
                previewImg.style.display = 'none';
                previewVideo.style.display = 'none';
                previewDivider.style.display = 'none';
                previewMarkdown.style.display = 'none';
                previewText.style.display = 'block';
                previewText.style.opacity = '0';
                previewText.textContent = 'Loading text...';

                // Fetch and display text file content
                fetch(currentMedia)
                    .then(response => response.text())
                    .then(text => {
                        // Add title before content
                        const title = `${currentItem.key}\n${'='.repeat(50)}\n\n`;
                        previewText.textContent = title + text;
                        previewText.style.opacity = '1';
                    })
                    .catch(error => {
                        previewText.textContent = 'Error loading text file: ' + error.message;
                        previewText.style.opacity = '1';
                    });
            } else if (isVideo) {
                // Hide all except video
                previewImg.style.display = 'none';
                previewText.style.display = 'none';
                previewMarkdown.style.display = 'none';
                previewDivider.style.display = 'none';
                previewVideo.style.display = 'block';
                previewVideo.style.opacity = '0';

                setTimeout(() => {
                    const source = previewVideo.querySelector('source');
                    source.src = currentMedia;

                    // Dynamically set the correct MIME type based on file extension
                    const extension = currentMedia.toLowerCase().split('.').pop().split('?')[0];
                    const mimeTypes = {
                        'mp4': 'video/mp4',
                        'webm': 'video/webm',
                        'ogg': 'video/ogg',
                        'mov': 'video/quicktime',
                        'avi': 'video/x-msvideo',
                        'mkv': 'video/x-matroska',
                        'm4v': 'video/x-m4v'
                    };
                    source.type = mimeTypes[extension] || 'video/mp4';

                    console.log(`üé• Loading video: ${currentMedia}`);
                    console.log(`   Extension: ${extension}`);
                    console.log(`   MIME type: ${source.type}`);

                    // Add comprehensive error handling
                    previewVideo.onerror = function(e) {
                        console.error('‚ùå Video error:', e);
                        console.error('   Error code:', previewVideo.error?.code);
                        console.error('   Error message:', previewVideo.error?.message);
                        console.error('   Network state:', previewVideo.networkState);
                        console.error('   Ready state:', previewVideo.readyState);
                    };

                    previewVideo.onloadstart = function() {
                        console.log('üì° Video load started');
                    };

                    previewVideo.onloadedmetadata = function() {
                        console.log('‚úì Metadata loaded');
                        console.log('   Duration:', previewVideo.duration);
                        console.log('   Video dimensions:', previewVideo.videoWidth, 'x', previewVideo.videoHeight);
                    };

                    previewVideo.oncanplay = function() {
                        console.log('‚úì Video can play');
                    };

                    previewVideo.oncanplaythrough = function() {
                        console.log('‚úì Video can play through');
                    };

                    previewVideo.load(); // Lazy load the video only when navigating to it

                    // Wait for metadata to load before playing
                    previewVideo.addEventListener('loadedmetadata', function playWhenReady() {
                        // Remove listener after first use to prevent duplicates
                        previewVideo.removeEventListener('loadedmetadata', playWhenReady);

                        // Attempt to play and handle the promise
                        const playPromise = previewVideo.play();
                        if (playPromise !== undefined) {
                            playPromise
                                .then(() => {
                                    console.log('‚úì Video playing successfully');
                                })
                                .catch(error => {
                                    console.warn('‚ö†Ô∏è Video play interrupted:', error);
                                });
                        }
                    });

                    previewVideo.style.opacity = '1';
                }, 150);
            } else {
                // Hide all except image
                previewVideo.style.display = 'none';
                previewText.style.display = 'none';
                previewMarkdown.style.display = 'none';
                previewDivider.style.display = 'none';
                previewImg.style.display = 'block';
                previewImg.style.opacity = '0';

                setTimeout(() => {
                    previewImg.src = currentMedia;
                    previewImg.style.opacity = '1';
                }, 150);
            }

            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === currentIndex);
            });

            // Scroll thumbnail into view
            scrollThumbnailIntoView(currentIndex);
        }

        // Update URL parameter to reflect current folder path or image index
        function updateUrlParameter(index) {
            // If we have a folder path loaded, keep it in the URL
            const folderPathInputElement = document.getElementById('folderPathInput');
            const loadedFolderPath = folderPathInputElement ? folderPathInputElement.value.trim() : '';
            if (loadedFolderPath) {
                const newUrl = `${window.location.pathname}?${encodeURIComponent(loadedFolderPath)}`;
                window.history.replaceState({}, '', newUrl);
            } else {
                // Fall back to numeric index if no folder path
                const newUrl = `${window.location.pathname}?${index + 1}`;
                window.history.replaceState({}, '', newUrl);
            }
        }

        // Scroll thumbnail into view (vertical sidebar)
        function scrollThumbnailIntoView(index) {
            const thumbnails = document.querySelectorAll('.thumbnail');
            if (thumbnails[index]) {
                thumbnails[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Navigate to Previous Image
        function prevImage() {
            currentIndex = (currentIndex - 1 + gallery_images.length) % gallery_images.length;
            changeImage(currentIndex);
        }

        // Navigate to Next Image
        function nextImage() {
            currentIndex = (currentIndex + 1) % gallery_images.length;
            changeImage(currentIndex);
        }

        // Thumbnail Carousel Navigation
        function scrollThumbnails(direction) {
            const scrollAmount = 250;
            const container = thumbnailsSlider.parentElement;
            const maxScroll = thumbnailsSlider.scrollWidth - container.offsetWidth;

            // Get current transform value
            const currentTransform = thumbnailsSlider.style.transform || 'translateX(0px)';
            const currentScroll = parseFloat(currentTransform.match(/-?\d+\.?\d*/)[0]) || 0;

            let newScroll;
            if (direction === 'prev') {
                newScroll = Math.max(0, currentScroll - scrollAmount);
            } else {
                newScroll = Math.min(maxScroll, currentScroll + scrollAmount);
            }

            thumbnailsSlider.style.transform = `translateX(-${newScroll}px)`;
            updateThumbnailNavButtons();
        }

        // Update thumbnail navigation button states
        function updateThumbnailNavButtons() {
            const currentTransform = thumbnailsSlider.style.transform || 'translateX(0px)';
            const currentScroll = parseFloat(currentTransform.match(/-?\d+\.?\d*/)[0]) || 0;
            const container = thumbnailsSlider.parentElement;
            const maxScroll = thumbnailsSlider.scrollWidth - container.offsetWidth;

            // Disable/enable buttons based on scroll position
            if (currentScroll <= 0) {
                thumbnailPrevBtn.classList.add('disabled');
            } else {
                thumbnailPrevBtn.classList.remove('disabled');
            }

            if (currentScroll >= maxScroll - 10) { // -10 for tolerance
                thumbnailNextBtn.classList.add('disabled');
            } else {
                thumbnailNextBtn.classList.remove('disabled');
            }
        }

        // Event Listeners
        prevBtn.addEventListener('click', prevImage);
        nextBtn.addEventListener('click', nextImage);
        thumbnailPrevBtn.addEventListener('click', () => scrollThumbnails('prev'));
        thumbnailNextBtn.addEventListener('click', () => scrollThumbnails('next'));

        // ============================================
        // NUMERIC KEYCODE NAVIGATION (0-9)
        // ============================================

        let numericBuffer = '';
        let numericTimeout = null;
        const NUMERIC_DELAY = 1500; // 1.5 seconds delay

        function handleNumericNavigation(digit) {
            // Add digit to buffer
            numericBuffer += digit;

            // Update input field to show what's being typed
            navInput.value = numericBuffer;
            navInput.classList.add('typing');

            // Clear previous timeout
            if (numericTimeout) {
                clearTimeout(numericTimeout);
            }

            // Set new timeout
            numericTimeout = setTimeout(() => {
                const targetNumber = parseInt(numericBuffer);

                if (!isNaN(targetNumber) && targetNumber >= 1 && targetNumber <= gallery_images.length) {
                    changeImage(targetNumber - 1); // Convert to 0-based index
                    navInput.style.borderColor = 'rgba(0, 255, 0, 0.7)';
                } else {
                    // Invalid number - show red border
                    navInput.style.borderColor = 'rgba(255, 0, 0, 0.8)';
                }

                // Clear buffer and input after short delay
                setTimeout(() => {
                    numericBuffer = '';
                    navInput.value = '';
                    navInput.classList.remove('typing');
                    navInput.style.borderColor = 'rgba(255, 255, 255, 0.5)';
                }, 500);
            }, NUMERIC_DELAY);
        }

        // Keyboard Navigation
        document.addEventListener('keydown', (e) => {
            // Check if user is typing in an input field
            const isInputFocused = document.activeElement.tagName === 'INPUT' ||
                                   document.activeElement.tagName === 'TEXTAREA';

            // Arrow key navigation
            if (e.key === 'ArrowLeft') {
                prevImage();
            } else if (e.key === 'ArrowRight' || e.key === ' ' || (e.key === 'Enter' && !isInputFocused)) {
                // Spacebar and Enter (when not in input) also advance to next image
                if ((e.key === ' ' || e.key === 'Enter') && !isInputFocused) {
                    e.preventDefault(); // Prevent default behavior
                }
                if (e.key !== 'Enter' || !isInputFocused) {
                    nextImage();
                }
            }
            // Numeric key navigation (0-9)
            else if (!isInputFocused && /^[0-9]$/.test(e.key)) {
                e.preventDefault(); // Prevent default behavior
                handleNumericNavigation(e.key);
            }
        });

        // Initialize Gallery
        checkUrlParameters(); // Check URL first to set the correct starting index
        generateThumbnails();
        changeImage(currentIndex); // This will display the image from URL parameter or default
        updateThumbnailNavButtons();

        // Update nav buttons on window resize
        window.addEventListener('resize', updateThumbnailNavButtons);

        // ============================================
        // DRAG-AND-DROP FILE HANDLING
        // ============================================

        // Prevent browser from opening dropped files in new tab
        window.addEventListener('dragover', function(e) {
            e.preventDefault();
        }, false);

        window.addEventListener('drop', function(e) {
            e.preventDefault();
        }, false);

        const dragDropBtn = document.getElementById('dragDropBtn');
        const dragDropFolderBtn = document.getElementById('dragDropFolderBtn');
        const fileInput = document.getElementById('file_input');
        const folderInput = document.getElementById('folder_input');

        // Prevent default drag behaviors on the buttons
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dragDropBtn.addEventListener(eventName, preventDefaults, false);
            dragDropFolderBtn.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight buttons when dragging over them
        ['dragenter', 'dragover'].forEach(eventName => {
            dragDropBtn.addEventListener(eventName, () => {
                dragDropBtn.classList.add('drag-over');
            }, false);
            dragDropFolderBtn.addEventListener(eventName, () => {
                dragDropFolderBtn.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dragDropBtn.addEventListener(eventName, () => {
                dragDropBtn.classList.remove('drag-over');
            }, false);
            dragDropFolderBtn.addEventListener(eventName, () => {
                dragDropFolderBtn.classList.remove('drag-over');
            }, false);
        });

        // Handle dropped files
        dragDropBtn.addEventListener('drop', handleDrop, false);
        dragDropFolderBtn.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // Handle files selected via file input
        fileInput.addEventListener('change', function(e) {
            const files = e.target.files;
            handleFiles(files);
        });

        // Handle folder selected via folder input
        folderInput.addEventListener('change', function(e) {
            const files = e.target.files;
            handleFilesWithSets(files);
        });

        // Process uploaded files (simple mode - no sets)
        function handleFiles(files) {
            const filesArray = Array.from(files);

            // Filter for images, videos, text files, and markdown files
            const validFiles = filesArray.filter(file => {
                const fileName = file.name.toLowerCase();
                return fileName.endsWith('.png') || fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') ||
                       fileName.endsWith('.mp4') || fileName.endsWith('.webm') || fileName.endsWith('.ogg') ||
                       fileName.endsWith('.mov') || fileName.endsWith('.avi') || fileName.endsWith('.mkv') ||
                       fileName.endsWith('.m4v') || fileName.endsWith('.txt') || fileName.endsWith('.md');
            });

            if (validFiles.length === 0) {
                alert('Please upload only image, video, text, or markdown files');
                return;
            }

            // Clear existing gallery
            gallery_images.length = 0;
            Object.keys(gallery_images_dict).forEach(key => delete gallery_images_dict[key]);

            // Add new files to gallery
            validFiles.forEach((file, index) => {
                const objectURL = URL.createObjectURL(file);
                const fileName = file.name.replace(/\.(png|jpg|jpeg|mp4|webm|ogg|mov|avi|mkv|m4v|txt|md)$/i, ''); // Remove extension
                const key = `file${index + 1}_${fileName}`;
                const isVideo = file.type.startsWith('video/');
                const isText = file.type === 'text/plain' || file.name.toLowerCase().endsWith('.txt');
                const isMarkdown = file.name.toLowerCase().endsWith('.md');

                gallery_images_dict[key] = objectURL;
                gallery_images.push({
                    key: key,
                    url: objectURL,
                    type: isMarkdown ? 'markdown' : (isText ? 'text' : (isVideo ? 'video' : 'image')),
                    isVideo: isVideo,
                    isText: isText,
                    isMarkdown: isMarkdown
                });
            });

            // Reset gallery
            currentIndex = 0;

            // Clear and regenerate thumbnails
            thumbnailsSlider.innerHTML = '';
            generateThumbnails();

            // Display first image/video
            changeImage(currentIndex);
            updateThumbnailNavButtons();

            // Update button text to show files loaded
            dragDropBtn.textContent = `‚úì ${validFiles.length} Files Loaded`;
            dragDropBtn.style.background = 'rgba(76, 175, 80, 1)';

            setTimeout(() => {
                dragDropBtn.textContent = 'üìÅ Drop Files Here';
                dragDropBtn.style.background = 'rgba(76, 175, 80, 0.9)';
            }, 2000);
        }

        // Process uploaded files with set organization (for folder upload)
        function handleFilesWithSets(files) {
            const filesArray = Array.from(files);

            // Filter for images, videos, text files, and markdown files
            const validFiles = filesArray.filter(file => {
                const fileName = file.name.toLowerCase();
                return fileName.endsWith('.png') || fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') ||
                       fileName.endsWith('.mp4') || fileName.endsWith('.webm') || fileName.endsWith('.ogg') ||
                       fileName.endsWith('.mov') || fileName.endsWith('.avi') || fileName.endsWith('.mkv') ||
                       fileName.endsWith('.m4v') || fileName.endsWith('.txt') || fileName.endsWith('.md');
            });

            if (validFiles.length === 0) {
                alert('Please upload only image, video, text, or markdown files');
                return;
            }

            // Organize files by subdirectory (maxdepth 1)
            const filesByFolder = {};
            const rootFiles = [];

            validFiles.forEach(file => {
                const relativePath = file.webkitRelativePath || file.name;
                const pathParts = relativePath.split('/');

                // When selecting a folder, the path is: folderName/subfolder/file.ext or folderName/file.ext
                // We want to group by the FIRST subdirectory after the root folder

                if (pathParts.length === 1) {
                    // File with no path (shouldn't happen with folder upload)
                    rootFiles.push(file);
                } else if (pathParts.length === 2) {
                    // Path: rootFolder/file.ext - file in root of selected folder
                    rootFiles.push(file);
                } else if (pathParts.length >= 3) {
                    // Path: rootFolder/subfolder/file.ext or deeper
                    // Store images in subdirectories for markdown image references
                    const fileName = file.name.toLowerCase();
                    if (fileName.endsWith('.png') || fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') ||
                        fileName.endsWith('.gif') || fileName.endsWith('.webp') || fileName.endsWith('.svg')) {
                        // Create blob URL and store with relative path (without root folder)
                        const relativePathFromRoot = pathParts.slice(1).join('/');
                        const blobUrl = URL.createObjectURL(file);
                        imagePathToBlobUrl[relativePathFromRoot] = blobUrl;
                        // Also store with ./ prefix
                        imagePathToBlobUrl['./' + relativePathFromRoot] = blobUrl;
                        console.log(`Stored subdirectory image for markdown: ${relativePathFromRoot}`);
                    } else {
                        console.log(`Skipping non-image file in subdirectory (maxdepth 0): ${relativePath}`);
                    }
                }
            });

            // Clear existing gallery
            gallery_images.length = 0;
            Object.keys(gallery_images_dict).forEach(key => delete gallery_images_dict[key]);

            let itemIndex = 0;
            let totalFiles = 0;
            const folderNames = Object.keys(filesByFolder).sort((a, b) =>
                a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
            );

            // Add sets for each folder
            folderNames.forEach(folderName => {
                const folderFiles = filesByFolder[folderName];

                // Sort files naturally
                folderFiles.sort((a, b) => {
                    const aName = a.name || a.webkitRelativePath.split('/').pop();
                    const bName = b.name || b.webkitRelativePath.split('/').pop();
                    return aName.localeCompare(bName, undefined, { numeric: true, sensitivity: 'base' });
                });

                // Add divider for this set
                const dividerKey = folderName;
                gallery_images_dict[dividerKey] = 'DIVIDER';
                gallery_images.push({
                    key: dividerKey,
                    url: 'DIVIDER',
                    type: 'divider',
                    isVideo: false,
                    isText: false
                });

                // Add files from this folder
                folderFiles.forEach(file => {
                    const objectURL = URL.createObjectURL(file);
                    const fileName = file.name.replace(/\.(png|jpg|jpeg|mp4|webm|ogg|mov|avi|mkv|m4v|txt|md)$/i, '');
                    const key = `${++itemIndex}_${fileName}`;
                    const isVideo = file.type.startsWith('video/');
                    const isText = file.type === 'text/plain' || file.name.toLowerCase().endsWith('.txt');
                    const isMarkdown = file.name.toLowerCase().endsWith('.md');

                    gallery_images_dict[key] = objectURL;
                    gallery_images.push({
                        key: key,
                        url: objectURL,
                        type: isMarkdown ? 'markdown' : (isText ? 'text' : (isVideo ? 'video' : 'image')),
                        isVideo: isVideo,
                        isText: isText,
                        isMarkdown: isMarkdown
                    });
                    totalFiles++;
                });
            });

            // Add root files if any (and if there are folders)
            if (rootFiles.length > 0) {
                if (folderNames.length > 0) {
                    // Add divider for root files
                    const dividerKey = 'Root Files';
                    gallery_images_dict[dividerKey] = 'DIVIDER';
                    gallery_images.push({
                        key: dividerKey,
                        url: 'DIVIDER',
                        type: 'divider',
                        isVideo: false,
                        isText: false
                    });
                }

                rootFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

                rootFiles.forEach(file => {
                    const objectURL = URL.createObjectURL(file);
                    const fileName = file.name.replace(/\.(png|jpg|jpeg|mp4|webm|ogg|mov|avi|mkv|m4v|txt|md)$/i, '');
                    const key = `${++itemIndex}_${fileName}`;
                    const isVideo = file.type.startsWith('video/');
                    const isText = file.type === 'text/plain' || file.name.toLowerCase().endsWith('.txt');
                    const isMarkdown = file.name.toLowerCase().endsWith('.md');

                    gallery_images_dict[key] = objectURL;
                    gallery_images.push({
                        key: key,
                        url: objectURL,
                        type: isMarkdown ? 'markdown' : (isText ? 'text' : (isVideo ? 'video' : 'image')),
                        isVideo: isVideo,
                        isText: isText,
                        isMarkdown: isMarkdown
                    });
                    totalFiles++;
                });
            }

            // Reset gallery
            currentIndex = 0;

            // Clear and regenerate thumbnails
            thumbnailsSlider.innerHTML = '';
            generateThumbnails();

            // Display first item
            changeImage(currentIndex);
            updateThumbnailNavButtons();

            // Update button text to show files loaded
            const setsCount = folderNames.length + (rootFiles.length > 0 && folderNames.length > 0 ? 1 : 0);
            const displayText = setsCount > 0 ? `‚úì ${totalFiles} Files (${setsCount} Sets)` : `‚úì ${totalFiles} Files Loaded`;
            dragDropFolderBtn.textContent = displayText;
            dragDropFolderBtn.style.background = 'rgba(76, 175, 80, 1)';

            setTimeout(() => {
                dragDropFolderBtn.textContent = 'üìÇ Drop Folder Here';
                dragDropFolderBtn.style.background = 'rgba(76, 175, 80, 0.9)';
            }, 2000);

            console.log(`‚úì Loaded ${totalFiles} files (${setsCount} sets)`);
        }

        // Modal Functions
        function openModal() {
            const modal = document.getElementById('referenceModal');
            const referenceList = document.getElementById('referenceList');

            // Clear existing content
            referenceList.innerHTML = '';

            // Generate reference list
            gallery_images.forEach((imgData, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'reference-item';

                const number = document.createElement('span');
                number.className = 'reference-number';
                number.textContent = `${index + 1}`;

                const key = document.createElement('span');
                key.className = 'reference-key';

                // Determine file type/extension
                let fileType = '';
                if (imgData.type === 'divider') {
                    fileType = '[DIVIDER]';
                } else if (imgData.isMarkdown) {
                    fileType = '.md';
                } else if (imgData.isText) {
                    fileType = '.txt';
                } else if (imgData.isVideo) {
                    // Try to extract actual extension from URL
                    const videoMatch = imgData.url.match(/\.(mp4|webm|ogg|mov|avi|mkv|m4v)/i);
                    fileType = videoMatch ? videoMatch[0].toLowerCase() : '.mp4';
                } else {
                    // Try to extract actual extension from URL for images
                    const imageMatch = imgData.url.match(/\.(jpg|jpeg|png|gif|bmp|webp|tiff|svg)/i);
                    fileType = imageMatch ? imageMatch[0].toLowerCase() : '.jpg';
                }

                key.textContent = `${imgData.key} ${fileType}`;

                const goBtn = document.createElement('button');
                goBtn.className = 'reference-go-btn';
                goBtn.textContent = 'Go';
                goBtn.onclick = function(e) {
                    e.stopPropagation();
                    goBtn.textContent = '‚úì';
                    goBtn.classList.add('clicked');
                    changeImage(index);
                    setTimeout(() => {
                        closeModal();
                    }, 500);
                };

                // Click to navigate
                listItem.onclick = function() {
                    goBtn.textContent = '‚úì';
                    goBtn.classList.add('clicked');
                    changeImage(index);
                    setTimeout(() => {
                        closeModal();
                    }, 500);
                };
                listItem.style.cursor = 'pointer';

                listItem.appendChild(number);
                listItem.appendChild(key);
                listItem.appendChild(goBtn);
                referenceList.appendChild(listItem);
            });

            modal.classList.add('show');
        }

        function closeModal() {
            const modal = document.getElementById('referenceModal');
            modal.classList.remove('show');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('referenceModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // ============================================
        // NAVIGATION INPUT FUNCTIONALITY
        // ============================================

        const navInput = document.getElementById('navInput');

        // Navigate to input number
        function navigateToInput() {
            const inputValue = parseInt(navInput.value);

            if (isNaN(inputValue) || inputValue < 1) {
                navInput.style.borderColor = 'rgba(255, 0, 0, 0.8)';
                setTimeout(() => {
                    navInput.style.borderColor = 'rgba(255, 255, 255, 0.5)';
                }, 500);
                return;
            }

            const targetIndex = inputValue - 1; // Convert to 0-based index

            if (targetIndex >= 0 && targetIndex < gallery_images.length) {
                changeImage(targetIndex);
                navInput.value = ''; // Clear input after navigation
                navInput.blur(); // Remove focus
            } else {
                // Invalid index
                navInput.style.borderColor = 'rgba(255, 0, 0, 0.8)';
                setTimeout(() => {
                    navInput.style.borderColor = 'rgba(255, 255, 255, 0.5)';
                }, 500);
            }
        }

        // Allow Enter key to navigate
        navInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                navigateToInput();
            }
        });

        // Update max attribute when gallery changes
        navInput.addEventListener('focus', function() {
            navInput.setAttribute('max', gallery_images.length);
        });

        // ============================================
        // FOLDER PATH LOADING (Server Mode)
        // ============================================

        const folderPathInput = document.getElementById('folderPathInput');

        // Load images from folder path via server
        async function loadFolderPath() {
            let folderPath = folderPathInput.value.trim();

            if (!folderPath) {
                alert('Please enter a folder path');
                return;
            }

            // Handle ./ as current directory
            if (folderPath === './') {
                folderPath = '.';
            }

            // Common image, video, text, and markdown extensions
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'tiff', 'svg'];
            const videoExtensions = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv', 'm4v'];
            const textExtensions = ['txt'];
            const markdownExtensions = ['md'];
            const allExtensions = [...imageExtensions, ...videoExtensions, ...textExtensions, ...markdownExtensions];

            try {
                // Try to fetch directory listing from server
                // This will work when running on a Python HTTP server
                const response = await fetch(folderPath);

                if (!response.ok) {
                    throw new Error(`Failed to access folder: ${response.status} ${response.statusText}`);
                }

                const html = await response.text();

                // Check if we got a directory listing or an HTML page
                const isDirectoryListing = html.includes('Index of') || html.includes('Directory listing for');

                if (!isDirectoryListing) {
                    // We got an HTML page (like index.html), not a directory listing
                    throw new Error(`The folder contains an index.html file. Please:\n1. Temporarily rename imageGallery/index.html\n2. Or use the folder browser buttons instead`);
                }

                // Parse HTML to extract file links
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Try different selectors - Python's SimpleHTTPServer might use different HTML
                let links = Array.from(doc.querySelectorAll('a'));

                if (links.length === 0) {
                    // Try li > a (Python 3 format)
                    links = Array.from(doc.querySelectorAll('li a'));
                }

                if (links.length === 0) {
                    // Try body > ul > li > a
                    links = Array.from(doc.querySelectorAll('body ul li a'));
                }

                console.log('Total links found:', links.length);
                console.log('All hrefs:', links.map(l => l.getAttribute('href')));

                // Separate subdirectories from files
                const subdirs = links
                    .map(link => link.getAttribute('href'))
                    .filter(href => {
                        if (!href || href === '../' || href.startsWith('?')) return false;
                        // Check if it's a directory (ends with / or is a known directory without /)
                        return href.endsWith('/') || (!href.includes('.'));
                    })
                    .map(href => href.replace(/\/$/, ''))
                    .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

                console.log('Found subdirectories:', subdirs);

                const directFiles = links
                    .map(link => link.getAttribute('href'))
                    .filter(href => {
                        if (!href || href === '../' || href.startsWith('?')) return false;
                        // Must have an extension and be a media file
                        if (!href.includes('.')) return false;
                        const extension = href.split('.').pop().toLowerCase();
                        return allExtensions.includes(extension);
                    })
                    .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

                console.log('Found direct files:', directFiles);

                // Clear existing gallery
                gallery_images.length = 0;
                Object.keys(gallery_images_dict).forEach(key => delete gallery_images_dict[key]);

                let totalFiles = 0;
                let itemIndex = 0;

                // If there are subdirectories, create sets for each
                if (subdirs.length > 0) {
                    console.log(`Processing ${subdirs.length} subdirectories...`);
                    for (const subdir of subdirs) {
                        // Fetch subdirectory contents
                        try {
                            console.log(`Fetching subdirectory: ${folderPath}/${subdir}`);
                            const subdirResponse = await fetch(`${folderPath}/${subdir}`);
                            if (!subdirResponse.ok) {
                                console.warn(`Failed to fetch ${subdir}: ${subdirResponse.status}`);
                                continue;
                            }

                            const subdirHtml = await subdirResponse.text();
                            const subdirDoc = new DOMParser().parseFromString(subdirHtml, 'text/html');
                            const subdirLinks = Array.from(subdirDoc.querySelectorAll('a'));

                            const subdirFiles = subdirLinks
                                .map(link => link.getAttribute('href'))
                                .filter(href => {
                                    if (!href || href === '../' || href.startsWith('?')) return false;
                                    // Must have extension and be a media file
                                    if (!href.includes('.')) return false;
                                    const extension = href.split('.').pop().toLowerCase();
                                    return allExtensions.includes(extension);
                                })
                                .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

                            console.log(`  Found ${subdirFiles.length} files in ${subdir}:`, subdirFiles);

                            if (subdirFiles.length > 0) {
                                // Add divider for this set
                                const dividerKey = `${subdir}`;
                                gallery_images_dict[dividerKey] = 'DIVIDER';
                                gallery_images.push({
                                    key: dividerKey,
                                    url: 'DIVIDER',
                                    type: 'divider',
                                    isVideo: false,
                                    isText: false
                                });

                                // Add files from this subdirectory
                                subdirFiles.forEach(file => {
                                    // Decode URL-encoded filenames (e.g., %20 -> space)
                                    const decodedFile = decodeURIComponent(file);
                                    const fullPath = `${folderPath}/${subdir}/${file}`;  // Keep original for URL
                                    const fileName = decodedFile.replace(/\.(png|jpg|jpeg|mp4|gif|bmp|webp|tiff|svg|webm|ogg|mov|avi|mkv|m4v|txt|md)$/i, '');
                                    const key = `${++itemIndex}_${fileName}`;

                                    console.log(`    Adding file: ${file} -> ${decodedFile}`);
                                    const extension = file.split('.').pop().toLowerCase();
                                    const isVideo = videoExtensions.includes(extension);
                                    const isText = textExtensions.includes(extension);
                                    const isMarkdown = markdownExtensions.includes(extension);

                                    gallery_images_dict[key] = fullPath;
                                    gallery_images.push({
                                        key: key,
                                        url: fullPath,
                                        type: isMarkdown ? 'markdown' : (isText ? 'text' : (isVideo ? 'video' : 'image')),
                                        isVideo: isVideo,
                                        isText: isText,
                                        isMarkdown: isMarkdown
                                    });
                                    totalFiles++;
                                });
                            }
                        } catch (error) {
                            console.error(`Error loading subdirectory ${subdir}:`, error);
                        }
                    }
                }

                // Add direct files (if any) as a separate set or standalone
                if (directFiles.length > 0) {
                    if (subdirs.length > 0) {
                        // Add divider for root files
                        const dividerKey = 'Root Files';
                        gallery_images_dict[dividerKey] = 'DIVIDER';
                        gallery_images.push({
                            key: dividerKey,
                            url: 'DIVIDER',
                            type: 'divider',
                            isVideo: false,
                            isText: false
                        });
                    }

                    directFiles.forEach(file => {
                        // Decode URL-encoded filenames (e.g., %20 -> space)
                        const decodedFile = decodeURIComponent(file);
                        const fullPath = `${folderPath}/${file}`;  // Keep original for URL
                        const fileName = decodedFile.replace(/\.(png|jpg|jpeg|mp4|gif|bmp|webp|tiff|svg|webm|ogg|mov|avi|mkv|m4v|txt|md)$/i, '');
                        const key = `${++itemIndex}_${fileName}`;

                        console.log(`  Adding direct file: ${file} -> ${decodedFile}`);
                        const extension = file.split('.').pop().toLowerCase();
                        const isVideo = videoExtensions.includes(extension);
                        const isText = textExtensions.includes(extension);
                        const isMarkdown = markdownExtensions.includes(extension);

                        gallery_images_dict[key] = fullPath;
                        gallery_images.push({
                            key: key,
                            url: fullPath,
                            type: isMarkdown ? 'markdown' : (isText ? 'text' : (isVideo ? 'video' : 'image')),
                            isVideo: isVideo,
                            isText: isText,
                            isMarkdown: isMarkdown
                        });
                        totalFiles++;
                    });
                }

                if (totalFiles === 0) {
                    alert(`No images or videos found in folder: ${folderPath}`);
                    folderPathInput.style.borderColor = 'rgba(255, 165, 0, 0.8)';
                    setTimeout(() => {
                        folderPathInput.style.borderColor = 'rgba(255, 255, 255, 0.5)';
                    }, 2000);
                    return;
                }

                // Reset gallery
                currentIndex = 0;

                // Clear and regenerate thumbnails
                thumbnailsSlider.innerHTML = '';
                generateThumbnails();

                // Display first image/video
                changeImage(currentIndex);
                updateThumbnailNavButtons();

                // Update URL to reflect the loaded folder path
                updateUrlParameter(currentIndex);

                // Update input to show success
                folderPathInput.style.borderColor = 'rgba(0, 255, 0, 0.7)';
                const setsCount = subdirs.length + (directFiles.length > 0 && subdirs.length > 0 ? 1 : 0);
                const displayText = setsCount > 0 ? `‚úì ${totalFiles} Files (${setsCount} Sets)` : `‚úì ${totalFiles} Files Loaded`;
                dragDropFolderBtn.textContent = displayText;
                dragDropFolderBtn.style.background = 'rgba(76, 175, 80, 1)';

                setTimeout(() => {
                    folderPathInput.style.borderColor = 'rgba(255, 255, 255, 0.5)';
                    dragDropFolderBtn.textContent = 'üìÇ Drop Folder Here';
                    dragDropFolderBtn.style.background = 'rgba(76, 175, 80, 0.9)';
                }, 2000);

                console.log(`‚úì Loaded ${totalFiles} files from ${folderPath} (${setsCount} sets)`);

            } catch (error) {
                console.error('Error loading folder:', error);

                // Fallback to file browser if server request fails
                alert(`Server access failed. Opening file browser instead.\n\nError: ${error.message}`);

                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.webkitdirectory = true;
                fileInput.multiple = true;

                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files);

                    // Filter files that match the folder path pattern
                    const matchingFiles = files.filter(file => {
                        const filePath = file.webkitRelativePath || file.name;
                        const matchesPath = filePath.includes(folderPath);
                        const extension = file.name.split('.').pop().toLowerCase();
                        const isMedia = allExtensions.includes(extension);
                        return matchesPath && isMedia;
                    });

                    if (matchingFiles.length === 0) {
                        alert(`No matching files found for path: ${folderPath}`);
                        return;
                    }

                    // Sort files naturally
                    matchingFiles.sort((a, b) => {
                        return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
                    });

                    // Clear existing gallery
                    gallery_images.length = 0;
                    Object.keys(gallery_images_dict).forEach(key => delete gallery_images_dict[key]);

                    // Add files to gallery
                    matchingFiles.forEach((file, index) => {
                        const objectURL = URL.createObjectURL(file);
                        const fileName = file.name.replace(/\.(png|jpg|jpeg|mp4|gif|bmp|webp|tiff|svg|webm|ogg|mov|avi|mkv|m4v|txt)$/i, '');
                        const key = `${index + 1}_${fileName}`;
                        const extension = file.name.split('.').pop().toLowerCase();
                        const isVideo = videoExtensions.includes(extension);
                        const isText = textExtensions.includes(extension);

                        gallery_images_dict[key] = objectURL;
                        gallery_images.push({ key: key, url: objectURL, isVideo: isVideo, isText: isText });
                    });

                    // Reset gallery
                    currentIndex = 0;

                    // Clear and regenerate thumbnails
                    thumbnailsSlider.innerHTML = '';
                    generateThumbnails();

                    // Display first image/video
                    changeImage(currentIndex);
                    updateThumbnailNavButtons();

                    // Update input to show success
                    folderPathInput.style.borderColor = 'rgba(0, 255, 0, 0.7)';
                    setTimeout(() => {
                        folderPathInput.style.borderColor = 'rgba(255, 255, 255, 0.5)';
                    }, 2000);
                };

                fileInput.click();
            }
        }

        // Allow Enter key to load folder
        folderPathInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadFolderPath();
            }
        });

        // ============================================
        // FONT SIZE CONTROLS
        // ============================================

        let currentFontSize = 16; // Default font size in pixels

        function changeFontSize(delta) {
            currentFontSize += delta;

            // Set minimum and maximum font sizes
            if (currentFontSize < 8) currentFontSize = 8;
            if (currentFontSize > 32) currentFontSize = 32;

            // Apply to both text and markdown preview elements
            previewText.style.fontSize = currentFontSize + 'px';
            previewMarkdown.style.fontSize = currentFontSize + 'px';

            // Visual feedback
            const increaseBtn = document.getElementById('fontSizeIncrease');
            const decreaseBtn = document.getElementById('fontSizeDecrease');

            if (delta > 0) {
                increaseBtn.style.background = 'rgba(76, 175, 80, 1)';
                setTimeout(() => {
                    increaseBtn.style.background = 'rgba(33, 150, 243, 0.9)';
                }, 200);
            } else {
                decreaseBtn.style.background = 'rgba(76, 175, 80, 1)';
                setTimeout(() => {
                    decreaseBtn.style.background = 'rgba(33, 150, 243, 0.9)';
                }, 200);
            }
        }

        // ============================================
        // REFERENCE IMAGE MODAL FUNCTIONALITY
        // ============================================

        let refImageIsEnlarged = false;
        let refImageLoaded = false;

        // Open file picker or show modal depending on whether image is loaded
        document.getElementById('loadRefImageBtn').addEventListener('click', function() {
            if (refImageLoaded) {
                // If image is already loaded, show the modal
                document.getElementById('refImageModal').style.display = 'block';
            } else {
                // Otherwise open file picker
                document.getElementById('refImageFileInput').click();
            }
        });

        // Load New Image button inside modal
        document.getElementById('loadNewRefImage').addEventListener('click', function() {
            document.getElementById('refImageFileInput').click();
        });

        // Handle file selection
        document.getElementById('refImageFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = document.getElementById('refImagePreview');
                    img.src = event.target.result;
                    img.style.display = 'block';
                    document.getElementById('refImagePlaceholder').style.display = 'none';
                    document.getElementById('loadRefImageBtn').textContent = 'üñºÔ∏è ' + file.name;
                    document.getElementById('refImageModalTitle').textContent = 'üñºÔ∏è ' + file.name;
                    refImageLoaded = true;
                    // Show the modal
                    document.getElementById('refImageModal').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Close Reference Image Modal
        document.getElementById('closeRefImageModal').addEventListener('click', function() {
            document.getElementById('refImageModal').style.display = 'none';
        });

        // Close modal when clicking outside
        document.getElementById('refImageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Toggle image size (enlarges the modal)
        document.getElementById('toggleRefImageSize').addEventListener('click', function() {
            const modal = document.getElementById('refImageModal');
            const modalContent = modal.querySelector('div');
            refImageIsEnlarged = !refImageIsEnlarged;
            if (refImageIsEnlarged) {
                modalContent.style.width = '95%';
                modalContent.style.maxWidth = '95%';
                modalContent.style.maxHeight = '95vh';
            } else {
                modalContent.style.width = '90%';
                modalContent.style.maxWidth = '800px';
                modalContent.style.maxHeight = '90vh';
            }
        });

        // Click on image to load new image
        document.getElementById('refImagePreview').addEventListener('click', function() {
            document.getElementById('refImageFileInput').click();
        });
    </script>
</body>
</html>


